{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json",
    "contentVersion": "0.0.1.1",
    "parameters": {
        "deploymentName": {
            "type": "string",
            "defaultValue": "sonarqube"
        },
        "sonarqubeImageVersion": {
            "type": "string",
            "defaultValue": "latest"
        },
        "servicePlanPricingTier": {
            "type": "string",
            "allowedValues": [
                "B1",
                "B2",
                "B3",
                "S1",
                "S2",
                "S3",
                "P1V2",
                "P2V2",
                "P3V2"
            ]
        },
        "servicePlanCapacity": {
            "type": "int",
            "defaultValue": 1,
            "minValue": 1,
            "maxValue": 3
        },
        "databaseAdminUsername": {
            "type": "string",
            "defaultValue": "db-admin",
            "minLength": 1
        },
        "databaseAdminPassword": {
            "type": "securestring",
            "minLength": 1
        },
        "databaseEdition": {
            "type": "string",
            "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
            ]
        },
        "databaseCollation": {
            "type": "string",
            "defaultValue": "Latin1_General_100_CS_AS",
            "minLength": 1
        }
    },
    "variables": {
        "location": "[resourceGroup().location]",
        "sqlServerName": "[concat('sql-', parameters('deploymentName'))]",
        "sqlDatabaseName": "[concat('sqldb-', parameters('deploymentName'))]",
        "sqlTemplateUri": "https://raw.githubusercontent.com/specialised-systems/azure-templates/master/templates/azure-sql-server-database/deploy.json",
        "servicePlanName": "[concat('plan-', parameters('deploymentName'))]",
        "servicePlanPricingTiers": {
            "F1": {
                "tier": "Free"
            },
            "B1": {
                "tier": "Basic"
            },
            "B2": {
                "tier": "Basic"
            },
            "B3": {
                "tier": "Basic"
            },
            "S1": {
                "tier": "Standard"
            },
            "S2": {
                "tier": "Standard"
            },
            "S3": {
                "tier": "Standard"
            },
            "P1V2": {
                "tier": "Standard"
            },
            "P2V2": {
                "tier": "Standard"
            },
            "P2V3": {
                "tier": "Standard"
            }
        },
        "webAppName": "[concat('app-', parameters('deploymentName'))]"
    },
    "resources": [
        {
            "apiVersion": "2015-01-01",
            "name": "[variables('sqlServerName')]",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('sqlTemplateUri')]"
                },
                "parameters": {
                    "adminUsername": {
                        "value": "[parameters('databaseAdminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('databaseAdminPassword')]"
                    },
                    "serverName": {
                        "value": "[variables('sqlServerName')]"
                    },
                    "databaseName": {
                        "value": "[variables('sqlDatabaseName')]"
                    },
                    "databaseEdition": {
                        "value": "[parameters('databaseEdition')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Web/serverfarms",
            "apiVersion": "2018-02-01",
            "name": "[variables('servicePlanName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "name": "[variables('servicePlanName')]",
                "workerSizeId": "1",
                "reserved": true,
                "numberOfWorkers": "1",
                "hostingEnvironment": ""
            },
            "sku": {
                "name": "[parameters('servicePlanPricingTier')]",
                "tier": "[variables('servicePlanPricingTiers')[parameters('servicePlanPricingTier')].tier]",
                "capacity": "[parameters('servicePlanCapacity')]"
            },
            "kind": "linux"
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2018-02-01",
            "name": "[variables('webAppName')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[variables('servicePlanName')]",
                "[variables('sqlServerName')]"
            ],
            "properties": {
                "siteConfig": {
                    "linuxFxVersion": "[concat('DOCKER|sonarqube',':',parameters('sonarqubeImageVersion'))]"
                },
                "name": "[variables('webAppName')]",
                "serverFarmId": "[variables('servicePlanName')]",
                "hostingEnvironment": ""
            },
            "resources": [
                {
                    "type": "config",
                    "apiVersion": "2018-02-01",
                    "name": "appsettings",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
                    ],
                    "properties": {
                        "SONARQUBE_JDBC_URL": "[reference(variables('sqlServerName')).outputs.connectionString.value]",
                        "SONARQUBE_JDBC_USERNAME": "[parameters('databaseAdminUsername')]",
                        "SONARQUBE_JDBC_PASSWORD": "[parameters('databaseAdminPassword')]"
                    }
                }
            ]
        }
    ]
}